#define flanger_alpha 0.75
#define FLANGER_BUFFER 1000

uint16_t flanger_circ[2][1000] = {0};
uint32_t i1_flanger = 0;
uint32_t i2_flanger = 0;
uint32_t n_flanger = 0;

uint16_t FlangerWave0[32] = {
 1024, 1464, 1871, 2220, 2500, 2705, 2828, 2866,
 2821, 2693, 2486, 2207, 1860, 1450, 1024, 496,
 0,  496, 1024, 1450, 1860, 2207, 2486, 2693,
 2821, 2866, 2828, 2705, 2500, 2220, 1871, 1464
}

uint16_t FlangerWave1[64] = {
  1024, 1122, 1219, 1314, 1407, 1495, 1580, 1658, 1731, 1797, 1855,
  1906, 1948, 1981, 2005, 2019, 2024, 2019, 2005, 1981, 1948, 1906,
  1855, 1797, 1731, 1658, 1580, 1495, 1407, 1314, 1219, 1122, 1024,
  926, 829, 734, 641, 553, 468, 390, 317, 251, 193, 142,
  100, 67, 43, 29, 24, 29, 43, 67, 100, 142, 193,
  251, 317, 390, 468, 553, 641, 734, 829, 926
};

uint16_t FlangerWave2[128] = {
 1024, 1074, 1124, 1174, 1224, 1274, 1324, 1374,
 1424, 1473, 1522, 1571, 1619, 1667, 1714, 1761,
 1807, 1852, 1897, 1941, 1984, 2026, 2067, 2107,
 2146, 2184, 2220, 2255, 2289, 2321, 2352, 2381,
 2408, 2434, 2458, 2480, 2500, 2519, 2536, 2550,
 2563, 2574, 2583, 2590, 2595, 2598, 2599, 2598,
 2595, 2590, 2583, 2574, 2563, 2550, 2536, 2519,
 2500, 2480, 2458, 2434, 2408, 2381, 2352, 2321,
 2289, 2255, 2220, 2184, 2146, 2107, 2067, 2026,
 1984, 1941, 1897, 1852, 1807, 1761, 1714, 1667,
 1619, 1571, 1522, 1473, 1424, 1374, 1324, 1274,
 1224, 1174, 1124, 1074, 1024,  974,  924,  874,
 824,  774,  724,  674,  624,  575,  526,  477,
 429,  381,  334,  287,  241,  196,  151,  107,
 64,   22,    1,    0,    1,   22,   64,  107,
 151,  196,  241,  287,  334,  381,  429,  477,
 526,  575,  624,  674,  724,  774,  824,  874,
 924,  974
};

uint16_t FlangerWave3[256] = {
 1024, 1049, 1074, 1099, 1124, 1149, 1174, 1199,
 1224, 1249, 1274, 1299, 1324, 1349, 1374, 1399,
 1424, 1449, 1474, 1499, 1524, 1549, 1574, 1599,
 1624, 1649, 1674, 1699, 1724, 1749, 1774, 1799,
 1824, 1849, 1874, 1899, 1924, 1949, 1974, 1999,
 2024, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
 2047, 2047, 2047, 2047, 2047, 2047, 2047, 2047,
 2047, 2024, 1999, 1974, 1949, 1924, 1899, 1874,
 1849, 1824, 1799, 1774, 1749, 1724, 1699, 1674,
 1649, 1624, 1599, 1574, 1549, 1524, 1499, 1474,
 1449, 1424, 1399, 1374, 1349, 1324, 1299, 1274,
 1249, 1224, 1199, 1174, 1149, 1124, 1099, 1074,
 1049, 1024, 999, 974, 949, 924, 899, 874,
 849, 824, 799, 774, 749, 724, 699, 674,
 649, 624, 599, 574, 549, 524, 499, 474,
 449, 424, 399, 374, 349, 324, 299, 274,
 249, 224, 199, 174, 149, 124, 99, 74,
 49, 24, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0,
 0, 24, 49, 74, 99, 124, 149, 174,
 199, 224, 249, 274, 299, 324, 349, 374,
 399, 424, 449, 474, 499, 524, 549, 574,
 599, 624, 649, 674, 699, 724, 749, 774,
 799, 824, 849, 874, 899, 924, 949, 974,
 999, 1024
}

uint16_t flanger_process_left_sample(uint16_t input_sample, uint16_t delay, uint16_t freq) {

  uint16_t output_sample;
  i2_flanger = i1_flanger;
  i1_flanger = (i1_flanger + 1) % FLANGER_BUFFER;
  flanger_circ[0][i2_flanger] = input_sample;



  uint32_t x_current;
  uint32_t x_delayed;
  uint32_t Kn;
  uint32_t ind;
  uint16_t period;

  x_current = flanger_circ[0][i2_flanger] / SCALE_FACTOR;

  switch (freq) {
    case 0:
      Kn = 0.5*delay*(FlangerWave0[n] + 1);
      period = 32;
      break;
    case 1:
      Kn = 0.5*delay*(FlangerWave1[n] + 1);
      period = 64;
      break;
    case 2:
      Kn = 0.5*delay*(FlangerWave2[n] + 1);
      period = 128;
      break;
    default:
      Kn = 0.5*delay*(FlangerWave3[n] + 1);
      period = 256;
      break;
  }

  if (Kn > i2_flanger) {
    ind = (i2 + FLANGER_BUFFER) - Kn;
  }
  else {
    ind = i2_flanger - Kn;
  }

  x_delayed = flanger_circ[0][ind] / SCALE_FACTOR;
  
  output_sample = (flanger_alpha*x_delayed) + x_current;
  n_flanger = (n_flanger + 1) % period;

  return output_sample;
}

uint16_t flanger_process_right_sample(uint16_t input_sample, uint16_t delay, uint16_t alpha) {

}